  //Jenkins pipeline to provision HDInsight infrastructure
    def azureSubscription = ""
    def inputSubscription = ""
    def skipRemainingStages = "true"

    pipeline {
    agent any
    parameters{

    {% if lookup('env', 'oozie_db') == 'false' %}
    booleanParam(defaultValue: false, name: 'oozie_db', description: 'Provision an Oozie database')
    {% else %}
    string(name: 'oozie_db_installed', defaultValue: 'The oozie_db is already installed' )
    {% endif %}
    {% if lookup('env', 'hive_db') == 'false' %}
    booleanParam(defaultValue: false, name: 'hive_db', description: 'Provision a Hive database')
    {% else %}
    string(name: 'hive_db_installed', defaultValue: 'The hive_db is already installed' )
    {% endif %}
    {% if lookup('env', 'ranger_db') == 'false' %}
    booleanParam(defaultValue: false, name: 'ranger_db', description: 'Provision a Ranger database')
    {% else %}
    string(name: 'ranger_db_installed', defaultValue: 'The oozie_db is already installed' )
    {% endif %}
    }

    environment
    {
        data_domain = {{ lookup('env', 'data_domain' }}
        resource_group_phase = {{ lookup('env', 'resource_group_phase') }}
        project_name = {{ lookup('env', 'project_name') }}
        env_type = {{ lookup('env', 'env_type') }}
    }

    stages {
    stage ('Git checkout and switch to Master') {
    steps {
    sh 'git checkout --track origin/mike'
    }
    }

    stage ('Provision HDI Infrastructure') {
    steps {

  withCredentials([azureServicePrincipal(credentialsId: '{{ lookup('env', 'CREDENTIAL_ID') }}' ,
                                                          subscriptionIdVariable: 'AZURE_SUBSCRIPTION_ID',
                                                          clientIdVariable: 'AZURE_CLIENT_ID',
                                                          clientSecretVariable: 'AZURE_SECRET',
                                                          tenantIdVariable: 'AZURE_TENANT')]) {
                                                          ansiblePlaybook extras: "-e @environments/{{ master_project_name }}/all", playbook: 'playbooks/provision-virtual-environment.yml', skippedTags: 'hdi'
  }
  }
  }

  }
  }

---
# tasks file for kafka-mockup-server

# Creates kafka group for kafka users.         
- name: Kafka-Server | Create kafka user group
  group:
    name: kafka
    state: present

# Create kafka user
- name: Kafka-Server | Create kafka users
  user:
    name: kafka
    group: kafka
    groups: wheel
    append: yes
    shell: /bin/bash
    create_home: yes
    state: present
    password: "{{ '123Sdp!' | password_hash('sha512') }}"

# Create download directory
- name: Kafka-Server | Create download directory
  file:
    become_user: kafka
    path: ~/downloads
    owner: "kafka"
    group: "kafka"
    state: directory
    recurse: yes

# Download Software
- name: Kafka-Server | Download kafka
  get_url:
    become_user: kafka
    url: "{{ kafka_download_url }}/{{ kafka_version }}/{{ kafka_file }}"
    dest: ~/downloads
    mode: '0440'

# Create untar working directory
- name: Kafka-Server | Create untar working directory
  file:
    become_user: kafka
    path: ~/kafka
    owner: "kafka"
    group: "kafka"
    state: directory
    recurse: yes

# Untar file    
- name: Extract kafka  to into ~/kafka
  unarchive:
    become_user: kafka
    src: ~/downloads/kafka_download_url
    dest: ~/kafka
    extra_opts: 
    - '--strip 1'

# Write zookeeper systemd unit file
- name: Write zookeeper systemd unit file
  template:
    src: zookerper-systemd.j2
    dest: /etc/systemd/system/zookeeper.service

# Write kafka systemd unit file
- name: Write kafka systemd unit file
  template:
    src: kafka-systemd.j2
    dest: /etc/systemd/system/kafka.service

# Start kafka
- name: Start service kafka, if not started
  service:
    name: kafka
    state: started
 